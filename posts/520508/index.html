<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>项目总结 | AZのBLOG</title><meta name="description" content="项目AZKK工具社区知识共享社区，通过签到获得AZ币（Redis的BitMap实现），可以利用AZ币执行抽奖和抵扣支付金额，对接微信公众号鉴权，使用会话模型与策略模式对接各大模型集成AI对话，通过微信支付充值AI对话额度，针对支付全流程可能出现的异常情况使用SpringTask做补偿（1. 订单到期关闭补偿，当订单超时未支付将会将订单关闭 2. 未收到支付回调补偿，当订单超过一分钟未更新支付状态时"><meta name="keywords" content="项目经历,SpringBoot"><meta name="author" content="AZ"><meta name="copyright" content="AZ"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/logo.png"><link rel="canonical" href="https://ch-azkk.github.io/posts/520508/"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin="crossorigin"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="preconnect" href="//zz.bdstatic.com"/><meta property="og:type" content="article"><meta property="og:title" content="项目总结"><meta property="og:url" content="https://ch-azkk.github.io/posts/520508/"><meta property="og:site_name" content="AZのBLOG"><meta property="og:description" content="项目AZKK工具社区知识共享社区，通过签到获得AZ币（Redis的BitMap实现），可以利用AZ币执行抽奖和抵扣支付金额，对接微信公众号鉴权，使用会话模型与策略模式对接各大模型集成AI对话，通过微信支付充值AI对话额度，针对支付全流程可能出现的异常情况使用SpringTask做补偿（1. 订单到期关闭补偿，当订单超时未支付将会将订单关闭 2. 未收到支付回调补偿，当订单超过一分钟未更新支付状态时"><meta property="og:image" content="https://ch-azkk.github.io/img/project.png"><meta property="article:published_time" content="2024-04-07T14:41:57.341Z"><meta property="article:modified_time" content="2024-04-07T15:06:44.932Z"><meta name="twitter:card" content="summary"><script>var activateDarkMode = function () {
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null) {
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#000')
  }
}
var activateLightMode = function () {
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null) {
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#fff')
  }
}

var getCookies = function (name) {
  const value = `; ${document.cookie}`
  const parts = value.split(`; ${name}=`)
  if (parts.length === 2) return parts.pop().split(';').shift()
}

var autoChangeMode = 'false'
var t = getCookies('theme')
if (autoChangeMode === '1') {
  var isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
  var isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
  var isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined) {
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport) {
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour <= 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
    }
    window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
      if (Cookies.get('theme') === undefined) {
        e.matches ? activateDarkMode() : activateLightMode()
      }
    })
  } else if (t === 'light') activateLightMode()
  else activateDarkMode()
} else if (autoChangeMode === '2') {
  now = new Date()
  hour = now.getHours()
  isNight = hour <= 6 || hour >= 18
  if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode()
} else {
  if (t === 'dark') activateDarkMode()
  else if (t === 'light') activateLightMode()
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css"><link rel="next" title="Acwing算法基础班" href="https://ch-azkk.github.io/posts/520501/"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?82612d3ab63b5c010c299bdc15d48ffa";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容:${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: {"limitDay":500,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: false,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: true,
  fancybox: true,
  Snackbar: {"bookmark":{"message_prev":"按","message_next":"键将本页加入书签"},"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#121212","position":"bottom-left"},
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  baiduPush: true,
  highlightCopy: true,
  highlightLang: true,
  isPhotoFigcaption: false,
  islazyload: true,
  isanchor: false    
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isSidebar: true,
  postUpdate: '2024-04-07 23:06:44'
}</script><noscript><style>
#nav {
  opacity: 1
}
.justified-gallery img{
  opacity: 1
}
</style></noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/sviptzk/HexoStaticFile/Hexo/css/flink.min.css"><link rel="stylesheet" href="/css/modify.css"><link rel="stylesheet" href="/css/iconfont.css"><!-- hexo injector head_end start --><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-double-row-display@1.00/cardlistpost.min.css"/>
<style>#recent-posts > .recent-post-item >.recent-post-info > .article-meta-wrap > .tags:before {content:"\A";
  white-space: pre;}#recent-posts > .recent-post-item >.recent-post-info > .article-meta-wrap > .tags > .article-meta__separator{display:none}</style>
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.0.0"></head><body><canvas class="fireworks"></canvas><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">8</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">19</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">8</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" target="_blank" rel="noopener" href="https://azkk.top/"><i class="fa-fw fa fa-desktop"></i><span> 社区</span></a></div><div class="menus_item"><a class="site-page" href="/box/"><i class="fa-fw fab fa-xbox"></i><span> 导航</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fas fa-list"></i><span> 媒体</span><i class="fas fa-chevron-down menus-expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li><li><a class="site-page" href="/books/"><i class="fa-fw fas fa-book"></i><span> 书单</span></a></li><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div></div></div></div><i class="fas fa-arrow-right on" id="toggle-sidebar"></i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE"><span class="toc-number">1.</span> <span class="toc-text">项目</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#AZKK%E5%B7%A5%E5%85%B7%E7%A4%BE%E5%8C%BA"><span class="toc-number">1.1.</span> <span class="toc-text">AZKK工具社区</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#AI%E5%AF%B9%E8%AF%9D%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.1.1.</span> <span class="toc-text">AI对话服务</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84"><span class="toc-number">1.1.1.1.</span> <span class="toc-text">项目结构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BE%AE%E4%BF%A1%E5%85%AC%E4%BC%97%E5%8F%B7%E5%AF%B9%E6%8E%A5"><span class="toc-number">1.1.1.2.</span> <span class="toc-text">微信公众号对接</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%99%BB%E5%BD%95%E9%89%B4%E6%9D%83"><span class="toc-number">1.1.1.3.</span> <span class="toc-text">登录鉴权</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%81%E5%BC%8F%E5%AF%B9%E8%AF%9D"><span class="toc-number">1.1.1.4.</span> <span class="toc-text">流式对话</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AF%B9%E8%AF%9D%E5%89%8D%E6%A0%A1%E9%AA%8C"><span class="toc-number">1.1.1.4.1.</span> <span class="toc-text">对话前校验</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E5%AF%B9%E8%AF%9D"><span class="toc-number">1.1.1.4.2.</span> <span class="toc-text">执行对话</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%A7%E6%A8%A1%E5%9E%8BSDK"><span class="toc-number">1.1.1.5.</span> <span class="toc-text">大模型SDK</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%A2%E5%8D%95%E6%94%AF%E4%BB%98"><span class="toc-number">1.1.1.6.</span> <span class="toc-text">订单支付</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E8%AE%A2%E5%8D%95"><span class="toc-number">1.1.1.6.1.</span> <span class="toc-text">创建订单</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%94%AF%E4%BB%98%E5%9B%9E%E8%B0%83"><span class="toc-number">1.1.1.6.2.</span> <span class="toc-text">支付回调</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#LuckyAZ"><span class="toc-number">1.2.</span> <span class="toc-text">LuckyAZ</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#lottery-rpc"><span class="toc-number">1.2.1.</span> <span class="toc-text">lottery-rpc</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#lottery-interfaces"><span class="toc-number">1.2.2.</span> <span class="toc-text">lottery-interfaces</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#lottery-application"><span class="toc-number">1.2.3.</span> <span class="toc-text">lottery-application</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#lottery-domain"><span class="toc-number">1.2.4.</span> <span class="toc-text">lottery-domain</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#activity%EF%BC%9A%E6%B4%BB%E5%8A%A8%E9%A2%86%E5%9F%9F%E2%80%93%E7%8A%B6%E6%80%81%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.2.4.1.</span> <span class="toc-text">activity：活动领域–状态模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#rule%EF%BC%9A%E8%A7%84%E5%88%99%E5%BC%95%E6%93%8E%E9%A2%86%E5%9F%9F%E2%80%93%E7%BB%84%E5%90%88%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.2.4.2.</span> <span class="toc-text">rule：规则引擎领域–组合模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#strategy%EF%BC%9A%E7%AD%96%E7%95%A5%E9%A2%86%E5%9F%9F%E2%80%93%E7%AD%96%E7%95%A5%E3%80%81%E6%A8%A1%E6%9D%BF%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.2.4.3.</span> <span class="toc-text">strategy：策略领域–策略、模板模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#award%EF%BC%9A%E5%8F%91%E5%A5%96%E9%A2%86%E5%9F%9F%E2%80%93%E7%AE%80%E5%8D%95%E5%B7%A5%E5%8E%82%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.2.4.4.</span> <span class="toc-text">award：发奖领域–简单工厂模式</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#lottery-infrastructure"><span class="toc-number">1.2.5.</span> <span class="toc-text">lottery-infrastructure</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#lottery-common%EF%BC%9A"><span class="toc-number">1.2.6.</span> <span class="toc-text">lottery-common：</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DB-Router%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8"><span class="toc-number">1.3.</span> <span class="toc-text">DB-Router分库分表</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%BB%E5%8F%96%E9%85%8D%E7%BD%AE%E4%BF%A1%E6%81%AF%E9%85%8D%E7%BD%AE%E6%95%B0%E6%8D%AE%E6%BA%90"><span class="toc-number">1.3.1.</span> <span class="toc-text">读取配置信息配置数据源</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1%E7%AE%A1%E7%90%86%E5%99%A8"><span class="toc-number">1.3.2.</span> <span class="toc-text">事务管理器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5"><span class="toc-number">1.3.3.</span> <span class="toc-text">路由策略</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89DBRouter%E6%B3%A8%E8%A7%A3%E5%AE%9E%E7%8E%B0%E5%88%86%E5%BA%93"><span class="toc-number">1.3.4.</span> <span class="toc-text">自定义DBRouter注解实现分库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89DBRouterStrategy%E5%AE%9E%E7%8E%B0%E5%88%86%E8%A1%A8"><span class="toc-number">1.3.5.</span> <span class="toc-text">自定义DBRouterStrategy实现分表</span></a></li></ol></li></ol></li></ol></div></div></div><div id="body-wrap"><div id="web_bg" data-type="photo"></div><header class="post-bg" id="page-header" style="background-image: url(/img/project.png)"><nav id="nav"><span class="pull-left" id="blog_name"><a class="blog_title" id="site-name" href="/">AZのBLOG</a></span><span class="pull-right menus"><div id="search_button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" target="_blank" rel="noopener" href="https://azkk.top/"><i class="fa-fw fa fa-desktop"></i><span> 社区</span></a></div><div class="menus_item"><a class="site-page" href="/box/"><i class="fa-fw fab fa-xbox"></i><span> 导航</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fas fa-list"></i><span> 媒体</span><i class="fas fa-chevron-down menus-expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li><li><a class="site-page" href="/books/"><i class="fa-fw fas fa-book"></i><span> 书单</span></a></li><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div></div><span class="toggle-menu close"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><div id="post-title"><div class="posttitle">项目总结</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date"><span class="post-meta__date-created" title="发表于 2024-04-07 22:41:57"><i class="far fa-calendar-alt fa-fw"></i> 发表于 2024-04-07</span><span class="post-meta__separator">|</span><span class="post-meta__date-updated" title="更新于 2024-04-07 23:06:44"><i class="fas fa-history fa-fw"></i> 更新于 2024-04-07</span></time><span class="post-meta__categories"><span class="post-meta__separator">|</span><i class="fas fa-inbox fa-fw post-meta__icon"></i><a class="post-meta__categories" href="/categories/%E9%A1%B9%E7%9B%AE%E7%BB%8F%E5%8E%86/">项目经历</a></span></div><div class="meta-secondline"> </div><div class="meta-thirdline"><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta__icon"></i><span>阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><h1 id="项目"><a href="#项目" class="headerlink" title="项目"></a>项目</h1><h2 id="AZKK工具社区"><a href="#AZKK工具社区" class="headerlink" title="AZKK工具社区"></a>AZKK工具社区</h2><p>知识共享社区，通过签到获得AZ币（Redis的BitMap实现），可以利用AZ币执行抽奖和抵扣支付金额，对接微信公众号鉴权，使用会话模型与策略模式对接各大模型集成AI对话，通过微信支付充值AI对话额度，针对支付全流程可能出现的异常情况使用SpringTask做补偿（1. 订单到期关闭补偿，当订单超时未支付将会将订单关闭 2. 未收到支付回调补偿，当订单超过一分钟未更新支付状态时会给向微信支付询问该支付单是否已经完成支付 3. 订单重新发货补偿，当订单已完成但未执行发货时做补偿），系统通过Nacos做注册中心、Dubbo进行服务间远程调用，Seata解决AZ币抵扣支付金额时的分布式事务问题</p>
<h3 id="AI对话服务"><a href="#AI对话服务" class="headerlink" title="AI对话服务"></a>AI对话服务</h3><h4 id="项目结构"><a href="#项目结构" class="headerlink" title="项目结构"></a>项目结构</h4><ul>
<li>chatgpt-data-app：程序启动服务，定义各种配置信息</li>
<li>chatgpt-data-trigger：触发器层，提供消息接收、接口实现、任务执行等，相当于MVC结构中的Controller</li>
<li>chatgpt-data-domain：领域层，主要有<ul>
<li>weixin：微信领域，公众号验签与消息应答</li>
<li>auth：登录鉴权领域，校验code是否存在，生成token，解析token等</li>
<li>limiter：限流领域<ul>
<li>Guava单机限流：RateLimiter令牌桶，以固定时间间隔往里面放令牌，每次尝试取出一个许可，失败则拒绝</li>
<li>Redis分布式限流：简单的使用String结构初始化值为1，过期时间设置为指定的时间间隔，每次访问自增1，判断是否超过指定的访问次数，超过则拒绝 </li>
</ul>
</li>
<li>openai：openai对话领域<ul>
<li>规则校验：账户状态校验、模型类型校验、账户额度校验、访问次数限制（有额度不校验）、敏感词校验</li>
<li>AI流式对话： 策略模式定位到指定的大模型实现中执行对话，ResponseBodyEmitter流式返回</li>
</ul>
</li>
<li>order：订单领域：查询商品列表、创建更新订单、执行发货等</li>
</ul>
</li>
<li>chatgpt-data-infrastructure：基础层，由领域层定义仓储接口，基础层实现，是依赖倒置的关系</li>
<li>chatgpt-data-type：公共层，定义公共工具类、常量、异常处理、枚举等</li>
</ul>
<h4 id="微信公众号对接"><a href="#微信公众号对接" class="headerlink" title="微信公众号对接"></a>微信公众号对接</h4><blockquote>
<p>微信服务器签名验证（验证合法性）,验证逻辑是将token、timestamp、nonce三个参数进行字典序排序，然后拼装成一个字符串进行sha1加密，若结果跟signature相同则说明验签成功，将echostr返回</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 处理微信服务器发来的get请求，进行签名的验证</span></span><br><span class="line"><span class="comment">     * &lt;a href=&quot;http://apix.natapp1.cc/api/v1/wx/portal/wxad979c0307864a66&quot;&gt;http://apix.natapp1.cc/api/v1/wx/portal/wxad979c0307864a66&lt;/a&gt;</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * appid     微信端AppID</span></span><br><span class="line"><span class="comment">     * signature 微信端发来的签名</span></span><br><span class="line"><span class="comment">     * timestamp 微信端发来的时间戳</span></span><br><span class="line"><span class="comment">     * nonce     微信端发来的随机字符串</span></span><br><span class="line"><span class="comment">     * echostr   微信端发来的验证字符串</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="meta">@GetMapping(produces = &quot;text/plain;charset=utf-8&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">validate</span><span class="params">(<span class="meta">@PathVariable(&quot;appid&quot;)</span> String appid,</span></span><br><span class="line"><span class="params">                       <span class="meta">@RequestParam(value = &quot;signature&quot;,required = false)</span> String signature,</span></span><br><span class="line"><span class="params">                       <span class="meta">@RequestParam(value = &quot;timestamp&quot;, required = false)</span> String timestamp,</span></span><br><span class="line"><span class="params">                       <span class="meta">@RequestParam(value = &quot;nonce&quot;, required = false)</span> String nonce,</span></span><br><span class="line"><span class="params">                       <span class="meta">@RequestParam(value = &quot;echostr&quot;, required = false)</span> String echostr)</span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//初步验证是否有属性为空</span></span><br><span class="line">        log.info(<span class="string">&quot;微信公众号验签信息&#123;&#125;开始 [&#123;&#125;, &#123;&#125;, &#123;&#125;, &#123;&#125;]&quot;</span>, appid, signature, timestamp, nonce, echostr);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isAnyBlank(signature,timestamp,nonce,echostr))&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;请求参数非法，请核实!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">checkSign</span> <span class="operator">=</span> validateService.checkSign(signature, timestamp, nonce);</span><br><span class="line">        <span class="keyword">if</span> (!checkSign) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">return</span> echostr;</span><br><span class="line">    &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">        log.error(<span class="string">&quot;微信公众号验签信息&#123;&#125;失败 [&#123;&#125;, &#123;&#125;, &#123;&#125;, &#123;&#125;]&quot;</span>, appid, signature, timestamp, nonce, echostr, e);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>公众号接收并处理用户信息，在项目中若用户在公众号发送的验证码为408则会随机构建4位code验证码，同时将openid与code的映射存入Guava缓存中，方便后续登录鉴权且为用户生成token</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> String <span class="title function_">acceptUserBehavior</span><span class="params">(UserBehaviorMessageEntity userBehaviorMessage)</span> &#123;</span><br><span class="line">    <span class="comment">//如果消息为事件消息则不处理</span></span><br><span class="line">    <span class="keyword">if</span> (MsgTypeVO.EVENT.getCode().equals(userBehaviorMessage.getMsgType())) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (MsgTypeVO.TEXT.getCode().equals(userBehaviorMessage.getMsgType())) &#123;</span><br><span class="line">        <span class="comment">//用户回复内容为408则处理，否则返回空</span></span><br><span class="line">        <span class="keyword">if</span> (userBehaviorMessage.getContent().equals(<span class="string">&quot;408&quot;</span>))&#123;</span><br><span class="line">            <span class="comment">//先从cache里面拿到code</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">isExitCode</span> <span class="operator">=</span> codeCache.getIfPresent(userBehaviorMessage.getOpenid());</span><br><span class="line">            <span class="keyword">if</span> (StringUtils.isBlank(isExitCode)) &#123;</span><br><span class="line">                <span class="comment">//如果cache中拿不到code</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">code</span> <span class="operator">=</span> RandomStringUtils.randomNumeric(<span class="number">4</span>);</span><br><span class="line">                <span class="comment">//将两个映射关系存入cache</span></span><br><span class="line">                codeCache.put(userBehaviorMessage.getOpenid(), code);</span><br><span class="line">                codeCache.put(code, userBehaviorMessage.getOpenid());</span><br><span class="line">                isExitCode = code;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//构建消息实体</span></span><br><span class="line">            <span class="type">MessageTextEntity</span> <span class="variable">messageText</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MessageTextEntity</span>();</span><br><span class="line">            messageText.setFromUserName(originalId);</span><br><span class="line">            messageText.setCreateTime(String.valueOf(System.currentTimeMillis() / <span class="number">1000L</span>));</span><br><span class="line">            messageText.setMsgType(<span class="string">&quot;text&quot;</span>);</span><br><span class="line">            messageText.setToUserName(userBehaviorMessage.getOpenid());</span><br><span class="line">            messageText.setContent(String.format(<span class="string">&quot;您的验证码为：%s 有效期%d分钟！&quot;</span>, isExitCode, <span class="number">3</span>));</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> XmlUtil.beanToXml(messageText);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ChatGPTException</span>(userBehaviorMessage.getMsgType()+<span class="string">&quot; 未支持处理的行为类型 Err!&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="登录鉴权"><a href="#登录鉴权" class="headerlink" title="登录鉴权"></a>登录鉴权</h4><ol>
<li><p>验证code是否存在，存在则构建验证信息，将缓存中code与openid映射关系去除</p>
</li>
<li><p>验证成功，生成token，openid作为负载，base64加密返回</p>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> AuthStateEntity <span class="title function_">doLogin</span><span class="params">(String code)</span> &#123;</span><br><span class="line">    <span class="comment">//初步验证，若code不为4位有效数字字符串直接return</span></span><br><span class="line">    <span class="keyword">if</span> (!code.matches(<span class="string">&quot;\\d&#123;4&#125;&quot;</span>))&#123;</span><br><span class="line">        log.info(<span class="string">&quot;鉴权，用户输入的验证码无效&#123;&#125;&quot;</span>,code);</span><br><span class="line">        <span class="keyword">return</span> AuthStateEntity.builder()</span><br><span class="line">            .code(AuthTypeVO.A0002.getCode())</span><br><span class="line">            .info(AuthTypeVO.A0002.getInfo())</span><br><span class="line">            .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">AuthStateEntity</span> <span class="variable">authStateEntity</span> <span class="operator">=</span> <span class="built_in">this</span>.checkCode(code);</span><br><span class="line">    <span class="keyword">if</span> (!authStateEntity.getCode().equals(AuthTypeVO.A0000.getCode()))&#123;</span><br><span class="line">        <span class="comment">//鉴权不成功直接返回</span></span><br><span class="line">        <span class="keyword">return</span> authStateEntity;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//生成token返回</span></span><br><span class="line">    HashMap&lt;String,Object&gt; chaim=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    chaim.put(<span class="string">&quot;openId&quot;</span>,authStateEntity.getOpenId());</span><br><span class="line">    String token=encode(authStateEntity.getOpenId(),<span class="number">7</span>*<span class="number">24</span>*<span class="number">60</span>*<span class="number">60</span>*<span class="number">1000L</span>,chaim);</span><br><span class="line">    authStateEntity.setToken(token);</span><br><span class="line">    <span class="keyword">return</span> authStateEntity;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">protected</span> AuthStateEntity <span class="title function_">checkCode</span><span class="params">(String code)</span> &#123;</span><br><span class="line">    <span class="comment">//从cache中取得openid</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">openId</span> <span class="operator">=</span> codeCache.getIfPresent(code);</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isBlank(openId))&#123;</span><br><span class="line">        log.info(<span class="string">&quot;鉴权，用户输入的验证码不存在 &#123;&#125;&quot;</span>, code);</span><br><span class="line">        <span class="keyword">return</span> AuthStateEntity.builder()</span><br><span class="line">            .code(AuthTypeVO.A0001.getCode())</span><br><span class="line">            .info(AuthTypeVO.A0001.getInfo())</span><br><span class="line">            .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//鉴权成功，删除cache内容</span></span><br><span class="line">    codeCache.invalidate(code);</span><br><span class="line">    codeCache.invalidate(openId);</span><br><span class="line"></span><br><span class="line">    log.info(<span class="string">&quot;鉴权成功，用户输入的验证码 &#123;&#125;&quot;</span>, code);</span><br><span class="line">    <span class="keyword">return</span> AuthStateEntity.builder()</span><br><span class="line">        .code(AuthTypeVO.A0000.getCode())</span><br><span class="line">        .info(AuthTypeVO.A0000.getInfo())</span><br><span class="line">        .openId(openId)</span><br><span class="line">        .build();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">protected</span> String <span class="title function_">encode</span><span class="params">(String issuer, <span class="type">long</span> ttlMillis, HashMap&lt;String, Object&gt; chaim)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (chaim==<span class="literal">null</span>)&#123;</span><br><span class="line">        chaim=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">long</span> <span class="variable">nowMills</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">    JwtBuilder builder= Jwts.builder()</span><br><span class="line">        <span class="comment">//荷载部分</span></span><br><span class="line">        .setClaims(chaim)</span><br><span class="line">        <span class="comment">//这个是JWT的唯一标识，一般设置成唯一的，这个方法可以生成唯一标识</span></span><br><span class="line">        .setId(UUID.randomUUID().toString())</span><br><span class="line">        <span class="comment">//签发人，也就是JWT是给谁的（逻辑上一般都是username或者userId）</span></span><br><span class="line">        .setIssuer(issuer)</span><br><span class="line">        <span class="comment">//签发时间</span></span><br><span class="line">        .setIssuedAt(<span class="keyword">new</span> <span class="title class_">Date</span>(nowMills))</span><br><span class="line">        <span class="comment">//使用算法与密钥生成jwt</span></span><br><span class="line">        .signWith(SignatureAlgorithm.HS256,base64EncodedSecretKey);</span><br><span class="line">    <span class="keyword">if</span> (ttlMillis&gt;<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="comment">//设置过期时间</span></span><br><span class="line">        <span class="type">long</span> expireTime=ttlMillis+nowMills;</span><br><span class="line">        builder.setExpiration(<span class="keyword">new</span> <span class="title class_">Date</span>(expireTime));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//生成token并返回</span></span><br><span class="line">    <span class="keyword">return</span> builder.compact();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="流式对话"><a href="#流式对话" class="headerlink" title="流式对话"></a>流式对话</h4><h5 id="对话前校验"><a href="#对话前校验" class="headerlink" title="对话前校验"></a>对话前校验</h5><blockquote>
<ol>
<li>token是否有效校验；2. 限流（频率）校验； 3. 执行对话</li>
</ol>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 1. 基础配置；流式输出、编码、禁用缓存</span></span><br><span class="line">    response.setContentType(<span class="string">&quot;text/event-stream&quot;</span>);</span><br><span class="line">    response.setCharacterEncoding(<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">    response.setHeader(<span class="string">&quot;Cache-Control&quot;</span>, <span class="string">&quot;no-cache&quot;</span>);</span><br><span class="line">    <span class="comment">// 2. 构建异步响应对象</span></span><br><span class="line">    <span class="type">ResponseBodyEmitter</span> <span class="variable">emitter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ResponseBodyEmitter</span>(<span class="number">3</span> * <span class="number">60</span> * <span class="number">1000L</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【对 Token 过期拦截】</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> authService.checkToken(token);</span><br><span class="line">    <span class="keyword">if</span> (!success)&#123;</span><br><span class="line">        <span class="comment">//校验token失败，token失效</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            emitter.send(Constants.ResponseCode.TOKEN_ERROR.getCode());</span><br><span class="line">        &#125;<span class="keyword">catch</span> (IOException e)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">        emitter.complete();</span><br><span class="line">        <span class="keyword">return</span> emitter;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//3.查看response状态,是否访问频率过快</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">isMostVisited</span> <span class="operator">=</span> response.getHeader(MOST_VISITED.getCode());</span><br><span class="line">    <span class="keyword">if</span>(isMostVisited!=<span class="literal">null</span>&amp;&amp;isMostVisited.equals(MOST_VISITED.getInfo()))&#123;</span><br><span class="line">        response.setHeader(MOST_VISITED.getCode(), <span class="string">&quot;&quot;</span>);</span><br><span class="line">        emitter.send(MOST_VISITED.getInfo());</span><br><span class="line">        emitter.complete();</span><br><span class="line">        <span class="keyword">return</span> emitter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4. 获取 OpenID</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">openId</span> <span class="operator">=</span> authService.getOpenId(token);</span><br><span class="line">    log.info(<span class="string">&quot;流式问答请求处理，openid:&#123;&#125; 请求模型:&#123;&#125;&quot;</span>, openId, request.getModel());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//5.构建参数</span></span><br><span class="line">    <span class="type">ChatProcessAggregate</span> <span class="variable">chatProcess</span> <span class="operator">=</span> ChatProcessAggregate.builder()</span><br><span class="line">        .model(request.getModel())</span><br><span class="line">        .openid(openId)</span><br><span class="line">        .messages(request.getMessages().stream()</span><br><span class="line">                  .map(entity -&gt; MessageEntity.builder()</span><br><span class="line">                       .role(entity.getRole())</span><br><span class="line">                       .content(entity.getContent())</span><br><span class="line">                       .name(entity.getName()).build())</span><br><span class="line">                  .collect(Collectors.toList()))</span><br><span class="line">        .build();</span><br><span class="line">    <span class="comment">//6.执行问答</span></span><br><span class="line">    <span class="keyword">return</span> chatService.completions(emitter,chatProcess);</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    log.error(<span class="string">&quot;流式应答，请求模型：&#123;&#125; 发生异常&quot;</span>, request.getModel(), e);</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ChatGPTException</span>(e.getMessage());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="执行对话"><a href="#执行对话" class="headerlink" title="执行对话"></a>执行对话</h5><ol>
<li>规则校验领域：<ol>
<li>账户状态校验（是否可用）；</li>
<li>模型类型校验（当前账户是否支持该模型）；</li>
<li>用户额度校验（是否有额度可以执行对话）；</li>
<li>访问次数校验（用户每天有固定免费访问次数，当账户不为空且有额度时不受访问次数限制）</li>
<li>敏感词校验（采用敏感词校验库给用户输入内容做敏感词捕捉并做无害化转换）</li>
</ol>
</li>
<li>通过规则校验后，根据选用的模型类型从策略模式构建的map中得到对应的模型实现，执行对话</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    emitter.onCompletion(() -&gt; &#123;</span><br><span class="line">        log.info(<span class="string">&quot;流式问答请求完成，使用模型:&#123;&#125;&quot;</span>, chatProcess.getModel());</span><br><span class="line">    &#125;);</span><br><span class="line">    emitter.onError(throwable -&gt; log.error(<span class="string">&quot;流式问答请求异常，使用模型：&#123;&#125;&quot;</span>, chatProcess.getModel(), throwable));</span><br><span class="line">    <span class="comment">//获取用户账户信息</span></span><br><span class="line">    <span class="type">UserAccountEntity</span> <span class="variable">userAccount</span> <span class="operator">=</span> openAiRepository.queryUserAccount(chatProcess.getOpenid());</span><br><span class="line">    <span class="comment">//规则过滤,传入进行过滤的模式列表</span></span><br><span class="line">    RuleLogicEntity&lt;ChatProcessAggregate&gt; ruleLogicEntity = <span class="built_in">this</span>.doCheckLogic(chatProcess, userAccount,</span><br><span class="line">                                                                              <span class="literal">null</span> != userAccount ? DefaultLogicFactory.LogicModel.ACCOUNT_STATUS.getCode() : DefaultLogicFactory.LogicModel.NULL.getCode(),</span><br><span class="line">                                                                              <span class="literal">null</span> != userAccount ? DefaultLogicFactory.LogicModel.MODEL_TYPE.getCode() : DefaultLogicFactory.LogicModel.NULL.getCode(),</span><br><span class="line">                                                                              <span class="literal">null</span> != userAccount ? DefaultLogicFactory.LogicModel.USER_QUOTA.getCode() : DefaultLogicFactory.LogicModel.NULL.getCode(),</span><br><span class="line">                                                                              DefaultLogicFactory.LogicModel.ACCESS_LIMIT.getCode(),</span><br><span class="line">                                                                              DefaultLogicFactory.LogicModel.SENSITIVE_WORD.getCode()</span><br><span class="line"></span><br><span class="line">                                                                             );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!LogicCheckTypeVO.SUCCESS.equals(ruleLogicEntity.getType())) &#123;</span><br><span class="line">        emitter.send(ruleLogicEntity.getInfo());</span><br><span class="line">        emitter.complete();</span><br><span class="line">        <span class="keyword">return</span> emitter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//处理问答</span></span><br><span class="line">    <span class="type">OpenAIChannel</span> <span class="variable">channel</span> <span class="operator">=</span> chatProcess.getChannel();</span><br><span class="line">    <span class="keyword">if</span> (channel==<span class="literal">null</span>)&#123;</span><br><span class="line">        emitter.send(<span class="string">&quot;暂未支持&quot;</span>+chatProcess.getModel()+<span class="string">&quot;模型！！&quot;</span>);</span><br><span class="line">        emitter.complete();</span><br><span class="line">        <span class="keyword">return</span> emitter;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">OpenAIGroupService</span> <span class="variable">openAIService</span> <span class="operator">=</span> openAIGroup.get(channel);</span><br><span class="line">    openAIService.doMessageResponse(ruleLogicEntity.getData(), emitter);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ChatGPTException</span>(Constants.ResponseCode.UN_ERROR);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//返回结果</span></span><br><span class="line">    <span class="keyword">return</span> emitter;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="大模型SDK"><a href="#大模型SDK" class="headerlink" title="大模型SDK"></a>大模型SDK</h4><p>对接大模型SDK采用的是会话模型，细节上使⽤OKHttp3与retrofit2 框架完成模型对接，通过工厂屏蔽使用细节，简化接口调用，像mybatis也是运用了这种结构，底层只有查和改两种操作（增删改都是改），但是通过会话工厂包装会话，提供增删改查四个接口，简化了接口调用，也方便用户调用。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Configuration</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">apiHost</span> <span class="operator">=</span> <span class="string">&quot;https://open.bigmodel.cn/&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 智普Ai https://open.bigmodel.cn/usercenter/apikeys - apiSecretKey = &#123;apiKey&#125;.&#123;apiSecret&#125;</span></span><br><span class="line">    <span class="keyword">private</span> String apiSecretKey;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String apiKey;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String apiSecret;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将apiSecretKey拆分获得apiKey &amp; apiSecret</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> apiSecretKey</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setApiSecretKey</span><span class="params">(String apiSecretKey)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.apiSecretKey=apiSecretKey;</span><br><span class="line">        String[] keyAndSecret = apiSecretKey.split(<span class="string">&quot;\\.&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (keyAndSecret.length!=<span class="number">2</span>)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;invalid apiSecretKey&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">this</span>.apiKey=keyAndSecret[<span class="number">0</span>];</span><br><span class="line">        <span class="built_in">this</span>.apiSecret=keyAndSecret[<span class="number">1</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> IOpenAiApi openAiApi;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> OkHttpClient okHttpClient;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建请求的长连接</span></span><br><span class="line">    <span class="keyword">public</span> EventSource.Factory <span class="title function_">createRequestFactory</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> EventSources.createFactory(okHttpClient);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> HttpLoggingInterceptor.Level level=HttpLoggingInterceptor.Level.HEADERS;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> <span class="variable">connectTimeout</span> <span class="operator">=</span> <span class="number">450</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> <span class="variable">writeTimeout</span> <span class="operator">=</span> <span class="number">450</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> <span class="variable">readTimeout</span> <span class="operator">=</span> <span class="number">450</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// http keywords</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SSE_CONTENT_TYPE</span> <span class="operator">=</span> <span class="string">&quot;text/event-stream&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DEFAULT_USER_AGENT</span> <span class="operator">=</span> <span class="string">&quot;Mozilla/4.0 (compatible; MSIE 5.0; Windows NT; DigExt)&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">APPLICATION_JSON</span> <span class="operator">=</span> <span class="string">&quot;application/json&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">JSON_CONTENT_TYPE</span> <span class="operator">=</span> APPLICATION_JSON + <span class="string">&quot;; charset=utf-8&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> OpenAiSession <span class="title function_">openSession</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//1.日志配置</span></span><br><span class="line">    HttpLoggingInterceptor httpLoggingInterceptor=<span class="keyword">new</span> <span class="title class_">HttpLoggingInterceptor</span>();</span><br><span class="line">    httpLoggingInterceptor.setLevel(configuration.getLevel());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2.开启http客户端</span></span><br><span class="line">    OkHttpClient okHttpClient=<span class="keyword">new</span> <span class="title class_">OkHttpClient</span></span><br><span class="line">        .Builder()</span><br><span class="line">        .addInterceptor(httpLoggingInterceptor)</span><br><span class="line">        .addInterceptor(<span class="keyword">new</span> <span class="title class_">OpenAiHTTPInterceptor</span>(configuration))</span><br><span class="line">        .readTimeout(configuration.getReadTimeout(), TimeUnit.SECONDS)</span><br><span class="line">        .writeTimeout(configuration.getWriteTimeout(),TimeUnit.SECONDS)</span><br><span class="line">        .connectTimeout(configuration.getConnectTimeout(),TimeUnit.SECONDS)</span><br><span class="line">        .build();</span><br><span class="line"></span><br><span class="line">    configuration.setOkHttpClient(okHttpClient);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3.创建API服务</span></span><br><span class="line">    IOpenAiApi openAiApi=<span class="keyword">new</span> <span class="title class_">Retrofit</span>.Builder()</span><br><span class="line">        .baseUrl(configuration.getApiHost())</span><br><span class="line">        .client(okHttpClient)</span><br><span class="line">        .addCallAdapterFactory(RxJava2CallAdapterFactory.create())</span><br><span class="line">        .addConverterFactory(JacksonConverterFactory.create())</span><br><span class="line">        .build().create(IOpenAiApi.class);</span><br><span class="line"></span><br><span class="line">    configuration.setOpenAiApi(openAiApi);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DefaultOpenAiSession</span>(configuration);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DefaultOpenAiSession</span> <span class="keyword">implements</span> <span class="title class_">OpenAiSession</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * OpenAi 配置</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Configuration configuration;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 工厂事件</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> EventSource.Factory factory;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">DefaultOpenAiSession</span><span class="params">(Configuration configuration)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.configuration = configuration;</span><br><span class="line">        <span class="built_in">this</span>.factory=configuration.createRequestFactory();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> EventSource <span class="title function_">completions</span><span class="params">(ChatCompletionRequest chatCompletionRequest, EventSourceListener eventSourceListener)</span> <span class="keyword">throws</span> JsonProcessingException &#123;</span><br><span class="line">        <span class="comment">//构建请求</span></span><br><span class="line">        Request request=<span class="keyword">new</span> <span class="title class_">Request</span>.Builder()</span><br><span class="line">                .url(configuration.getApiHost().concat(IOpenAiApi.v3_completions).replace(<span class="string">&quot;&#123;model&#125;&quot;</span>,chatCompletionRequest.getModel().getCode()))</span><br><span class="line">                .post(RequestBody.create(MediaType.parse(<span class="string">&quot;application/json&quot;</span>),chatCompletionRequest.toString())).build();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> factory.newEventSource(request,eventSourceListener);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> CompletableFuture&lt;String&gt; <span class="title function_">completions</span><span class="params">(ChatCompletionRequest chatCompletionRequest)</span> <span class="keyword">throws</span> InterruptedException&#123;</span><br><span class="line">        <span class="comment">// 用于执行异步任务并获取结果</span></span><br><span class="line">        CompletableFuture&lt;String&gt; future=<span class="keyword">new</span> <span class="title class_">CompletableFuture</span>&lt;&gt;();</span><br><span class="line">        StringBuffer dataBuffer=<span class="keyword">new</span> <span class="title class_">StringBuffer</span>();</span><br><span class="line">        <span class="comment">//构建请求</span></span><br><span class="line">        Request request=<span class="keyword">new</span> <span class="title class_">Request</span>.Builder()</span><br><span class="line">                .url(configuration.getApiHost().concat(IOpenAiApi.v3_completions).replace(<span class="string">&quot;&#123;model&#125;&quot;</span>,chatCompletionRequest.getModel().getCode()))</span><br><span class="line">                .post(RequestBody.create(MediaType.parse(<span class="string">&quot;application/json&quot;</span>),chatCompletionRequest.toString())).build();</span><br><span class="line">        <span class="comment">// 异步响应请求</span></span><br><span class="line">        factory.newEventSource(request, <span class="keyword">new</span> <span class="title class_">EventSourceListener</span>() &#123;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onEvent</span><span class="params">(EventSource eventSource, <span class="meta">@Nullable</span> String id, <span class="meta">@Nullable</span> String type, String data)</span> &#123;</span><br><span class="line">                <span class="comment">//将Json格式的结果转化为类对象</span></span><br><span class="line">                <span class="type">ChatCompletionResponse</span> <span class="variable">response</span> <span class="operator">=</span> JSON.parseObject(data, ChatCompletionResponse.class);</span><br><span class="line">                <span class="keyword">if</span> (EventType.add.getCode().equals(type))&#123;</span><br><span class="line">                    dataBuffer.append(response.getData());</span><br><span class="line">                &#125;<span class="keyword">else</span> <span class="keyword">if</span> (EventType.finish.getCode().equals(type))&#123;</span><br><span class="line">                    future.complete(dataBuffer.toString());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClosed</span><span class="params">(EventSource eventSource)</span> &#123;</span><br><span class="line">                future.completeExceptionally(<span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Request closed before completion&quot;</span>));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onFailure</span><span class="params">(EventSource eventSource, <span class="meta">@Nullable</span> Throwable t, <span class="meta">@Nullable</span> Response response)</span> &#123;</span><br><span class="line">                future.completeExceptionally(<span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Request closed before completion&quot;</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> future;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用：yml中配置模型的配置信息，包装成对应的Configuration对话，交给对应的工厂开启会话，其实工厂做的事情也是包装Configuration里面的OkHttpClient客户端、IOpenAiApi服务等等，最后把Configuration交给会话使得会话可以通过这些信息执行操作</p>
<h4 id="订单支付"><a href="#订单支付" class="headerlink" title="订单支付"></a>订单支付</h4><h5 id="创建订单"><a href="#创建订单" class="headerlink" title="创建订单"></a>创建订单</h5><ol>
<li>校验token是否有效</li>
<li>若用户选择使用AZ币抵扣支付金额，则会通过Dubbo远程调用得到用户当前AZ币数量，再得到优惠金额</li>
<li>包装购物车，将商品ID、openid、用户ID、优惠金额等等包装成购物车实体</li>
<li>判断同个购物车下是否有未支付的订单，有则返回，无则判断商品是否有效，创建订单，再调用蓝兔支付获取支付单，写入并返回</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 模板方法定义用户下单流程</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> shopCarEntity 简单购物车</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 支付单实体对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> PayOrderEntity <span class="title function_">createOrder</span><span class="params">(ShopCarEntity shopCarEntity)</span> <span class="keyword">throws</span> AlipayApiException &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//0.获取购物车信息，商品与用户</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">openid</span> <span class="operator">=</span> shopCarEntity.getOpenid();</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">productId</span> <span class="operator">=</span> shopCarEntity.getProductId();</span><br><span class="line">        <span class="type">BigDecimal</span> <span class="variable">discountAmount</span> <span class="operator">=</span> shopCarEntity.getDiscountAmount();</span><br><span class="line">        <span class="type">String</span> <span class="variable">userId</span> <span class="operator">=</span> shopCarEntity.getUserId();</span><br><span class="line">        <span class="comment">//获取是否未支付的订单</span></span><br><span class="line">        UnpaidOrderEntity unpaidOrder=orderRepository.queryUnpaidOrder(shopCarEntity);</span><br><span class="line">        <span class="keyword">if</span> (unpaidOrder!=<span class="literal">null</span>&amp;&amp;PayStatusVO.WAIT.equals(unpaidOrder.getPayStatus())&amp;&amp;</span><br><span class="line">            unpaidOrder.getPayUrl()!=<span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="comment">//有等待支付的有效订单切有相应的payUrl,直接返回</span></span><br><span class="line">            log.info(<span class="string">&quot;创建订单-存在，已生成支付宝支付，返回 openid: &#123;&#125; orderId: &#123;&#125; payUrl: &#123;&#125;&quot;</span>, openid, unpaidOrder.getOrderId(), unpaidOrder.getPayUrl());</span><br><span class="line">            <span class="keyword">return</span> PayOrderEntity.builder()</span><br><span class="line">                .orderId(unpaidOrder.getOrderId())</span><br><span class="line">                .payStatus(unpaidOrder.getPayStatus())</span><br><span class="line">                .openid(openid)</span><br><span class="line">                .payUrl(unpaidOrder.getPayUrl()).build();</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span> (unpaidOrder!=<span class="literal">null</span>&amp;&amp;unpaidOrder.getPayUrl()==<span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="comment">//没有相应的支付地址</span></span><br><span class="line">            log.info(<span class="string">&quot;创建订单-存在，未生成支付宝支付，返回 openid: &#123;&#125; orderId: &#123;&#125;&quot;</span>, openid, unpaidOrder.getOrderId());</span><br><span class="line">            PayOrderEntity payOrderEntity=<span class="built_in">this</span>.doPrepayOrder(openid,unpaidOrder.getOrderId(),</span><br><span class="line">                                                             unpaidOrder.getProductName(),unpaidOrder.getTotalAmount());</span><br><span class="line">            log.info(<span class="string">&quot;创建订单-完成，已生成支付宝支付，返回 openid: &#123;&#125; orderId: &#123;&#125; payUrl: &#123;&#125;&quot;</span>, openid, unpaidOrder.getOrderId(), unpaidOrder.getPayUrl());</span><br><span class="line">            <span class="keyword">return</span> payOrderEntity;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//没有未支付的订单 1.查询商品信息</span></span><br><span class="line">        ProductEntity productEntity=orderRepository.queryProduct(productId);</span><br><span class="line">        <span class="keyword">if</span> (!productEntity.isAvailable()) &#123;</span><br><span class="line">            <span class="comment">//商品无效</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ChatGPTException</span>(Constants.ResponseCode.ORDER_PRODUCT_ERR.getCode(), Constants.ResponseCode.ORDER_PRODUCT_ERR.getInfo());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//2.新建订单并保存</span></span><br><span class="line">        OrderEntity orderEntity=<span class="built_in">this</span>.doSaveOrder(shopCarEntity,productEntity);</span><br><span class="line">        <span class="comment">//3.创建支付，与订单入库没法做事务，由定时任务补偿,注意总价需要减去优惠金额</span></span><br><span class="line">        <span class="type">PayOrderEntity</span> <span class="variable">payOrderEntity</span> <span class="operator">=</span> doPrepayOrder(openid, orderEntity.getOrderId(), productEntity.getProductName(),</span><br><span class="line">                                                      orderEntity.getTotalAmount().subtract(discountAmount).setScale(<span class="number">2</span>,BigDecimal.ROUND_HALF_UP));</span><br><span class="line">        log.info(<span class="string">&quot;创建订单-完成，生成支付单。openid: &#123;&#125; orderId: &#123;&#125; payUrl: &#123;&#125;&quot;</span>, openid, orderEntity.getOrderId(), payOrderEntity.getPayUrl());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> payOrderEntity;</span><br><span class="line">    &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">        log.info(<span class="string">&quot;创建订单-失败。openid: &#123;&#125; productId:&#123;&#125;&quot;</span>, shopCarEntity.getOpenid(),shopCarEntity.getProductId());</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ChatGPTException</span>(Constants.ResponseCode.UN_ERROR.getCode(), Constants.ResponseCode.UN_ERROR.getInfo());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> PayOrderEntity <span class="title function_">doPrepayOrder</span><span class="params">(String openid, String orderId, String productName, BigDecimal totalAmount)</span> <span class="keyword">throws</span> AlipayApiException &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 策略服务可以根据类型动态选择,这里写死,后续可更换传参形式</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">payUrl</span> <span class="operator">=</span> payGroup.get(PayChannel.LTPay).createPayUrl(orderId, productName, totalAmount);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//构建支付单</span></span><br><span class="line">    <span class="type">PayOrderEntity</span> <span class="variable">payOrderEntity</span> <span class="operator">=</span> PayOrderEntity.builder()</span><br><span class="line">        .payUrl(payUrl)</span><br><span class="line">        .payStatus(PayStatusVO.WAIT)</span><br><span class="line">        .openid(openid)</span><br><span class="line">        .orderId(orderId)</span><br><span class="line">        .build();</span><br><span class="line">    <span class="comment">//更新订单支付信息</span></span><br><span class="line">    orderRepository.updateOrderPayInfo(payOrderEntity);</span><br><span class="line">    <span class="keyword">return</span> payOrderEntity;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="支付回调"><a href="#支付回调" class="headerlink" title="支付回调"></a>支付回调</h5><ol>
<li>更新订单支付状态</li>
<li>发送EventBus消息推送</li>
<li>job监听消息执行发货：判断订单是否使用了AZ币抵扣，有则远程调用扣减AZ币，最后给账户添加额度</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deliverGoods</span><span class="params">(String orderId)</span> &#123;</span><br><span class="line">    <span class="type">OrderEntity</span> <span class="variable">orderEntity</span> <span class="operator">=</span> orderRepository.queryDiscountOrder(orderId);</span><br><span class="line">    <span class="keyword">if</span> (orderEntity!=<span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="comment">//用户使用优惠且未发货订单</span></span><br><span class="line">        log.info(<span class="string">&quot;远程调用扣减用户AZ币：用户ID：&#123;&#125; AZ币：&#123;&#125;&quot;</span>,orderEntity.getUserId());</span><br><span class="line">        <span class="type">boolean</span> subAzCoins= userRpcService.subAzCoins(orderEntity.getDiscountAmount()</span><br><span class="line">        	.multiply(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="number">10</span>)).setScale(<span class="number">2</span>, RoundingMode.HALF_UP).doubleValue(),</span><br><span class="line">        	orderEntity.getUserId());</span><br><span class="line">        <span class="keyword">if</span> (!subAzCoins)&#123;</span><br><span class="line">        	log.error(<span class="string">&quot;远程调用扣减用户AZ币失败&quot;</span>);</span><br><span class="line">        	<span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    orderRepository.deliverGoods(orderId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="LuckyAZ"><a href="#LuckyAZ" class="headerlink" title="LuckyAZ"></a>LuckyAZ</h2><p><img src= "/img/loading.gif" data-src="https://qiniu.azkk.top/typora/image-20240404194902266.png" alt="image-20240404194902266"></p>
<h3 id="lottery-rpc"><a href="#lottery-rpc" class="headerlink" title="lottery-rpc"></a>lottery-rpc</h3><blockquote>
<p>提供rpc接口信息，调用方通过rpc调用时需要引入的jar包</p>
</blockquote>
<ul>
<li>指定活动抽奖：用户指定了活动ID执行抽奖</li>
<li>量化人群执行抽奖：量化物料通过组合模式路由到对应的活动ID，执行抽奖</li>
</ul>
<h3 id="lottery-interfaces"><a href="#lottery-interfaces" class="headerlink" title="lottery-interfaces"></a>lottery-interfaces</h3><blockquote>
<p>应用启动与配置，实现rpc接口</p>
</blockquote>
<h3 id="lottery-application"><a href="#lottery-application" class="headerlink" title="lottery-application"></a>lottery-application</h3><blockquote>
<p>应用层，进行领域的编排</p>
</blockquote>
<ul>
<li>执行抽奖<ul>
<li>活动领取（第一次领取则发送MQ扣减活动库存）</li>
<li>通过活动策略执行抽奖，包装中奖信息</li>
<li>抽奖结果落库</li>
<li>MQ发送通知触发发奖流程，返回中奖结果</li>
</ul>
</li>
<li>量化人群：根据决策物料调用规则过滤引擎得到对应的活动</li>
<li>MQ消息（设置setConfirmCallback消息到达MQ之后设置发货单MQ发送状态为已发送，同时依靠xxl-job定时扫描发货单，若MQ状态未发送则执行重发补偿，同时关闭MQ的自动ack，在消费者也就是执行完发奖之后再手动返回ack，并且在数据库中设计了防重字段保证消息消费幂等性，也就是说不会重复消费，活动领取uuid设计为用户ID加上活动ID加上已领取次数，发奖uuid单纯使用订单ID做防重）<ul>
<li>初次领取活动会发送MQ消息执行活动库存扣减</li>
<li>发奖工厂获取相应发奖实例执行发奖</li>
</ul>
</li>
<li>xxl-job任务调度<ul>
<li>扫描审核通过的活动，活动时间到更换为活动中</li>
<li>活动中的活动到期关闭</li>
<li>MQ消息发送失败补偿</li>
</ul>
</li>
</ul>
<h3 id="lottery-domain"><a href="#lottery-domain" class="headerlink" title="lottery-domain"></a>lottery-domain</h3><h4 id="activity：活动领域–状态模式"><a href="#activity：活动领域–状态模式" class="headerlink" title="activity：活动领域–状态模式"></a>activity：活动领域–状态模式</h4><ul>
<li><p>活动配置：全流程事务控制，有一个失败则rollback</p>
<p>​                    包括活动信息（活动ID、名称、描述、开始结束时间、库存、每人可参与次数、状态、对应的策略ID）</p>
<p>​                    奖品信息（奖品ID、奖品类型–优惠券/实物等、奖品名称、奖品内容）</p>
<p>​                    策略信息（策略ID、策略描述、策略算法、发奖方式、发奖文案等）</p>
<p>​                    策略详情（策略ID、奖品ID、奖品名称、奖品库存、奖品剩余库存、中奖概率）</p>
</li>
<li><p>活动状态流转：状态模式（对于所有修改状态的操作来说其实对于每个状态都是存在的，只是有些操作针对当前状态来说无权修改，所以针对每个状态定义实现类实现操作接口，有无权力执行修改状态操作由自身实现类实现，我们无需关心，只需要根据当前状态调用状态实现类的操作即可）</p>
<blockquote>
<p>定义抽象类AbstractState：包括所有状态操作(提审、通过、拒绝、撤审、关闭、开启、进行中) </p>
<p>针对每一个状态定义一个状态实现类，继承AbstractState，作为当前状态执行各状态操作的 结果，若当前状态不可执行操作则返回，否则执行状态转换操作。 </p>
<p>定义配置类StateConfig：初始化状态与对应状态实现类的对应关系的Map集合stateGroup </p>
<p>IStateHandler接口：状态处理接口，定义所有状态操作接口 </p>
<p>StateHandlerImpl实现类：继承StateConfig，实现IStateHandler接口，从stateGroup中获 得当前状态对应的状态实现类，执行相应的操作，不用关心当前状态是否可以执行此操作， 在状态实现类中已经有相应的处理，这样让我们不必在业务逻辑中做if-else来判断但概念状 态是否可以执行相应的操作，造成逻辑混乱且不易修改和扩展。</p>
</blockquote>
</li>
<li><p>活动领取：</p>
<ul>
<li><p>若有已领取未执行活动单则直接返回</p>
</li>
<li><p>校验活动状态、活动库存、日期是否有效、个人参与次数等</p>
</li>
<li><p>扣减活动库存——！！这里针对热门活动领取采用分段竞态锁来缩小锁的的粒度，防止超卖</p>
<p>也就是每次进来扣减一次当前库存，判断是否超过了活动库存，超过恢复原始库存，扣减成功用setnx给活动的当前库存加锁，加锁失败恢复，也就是不针对活动加独占锁，而是针对活动的某个库存加锁，细化锁的粒度，当执行完活动领取后记得将锁释放</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> StockResult <span class="title function_">subtractionActivityStockByRedis</span><span class="params">(String uId, Long activityId, Integer stockCount)</span> &#123;</span><br><span class="line">    <span class="comment">//获取活动key</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">stockKey</span> <span class="operator">=</span> Constants.RedisKey.KEY_LOTTERY_ACTIVITY_STOCK_COUNT(activityId);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//扣减库存，已使用库存+1</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">stockUsedCount</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().increment(stockKey, <span class="number">1</span>).intValue();</span><br><span class="line">    <span class="keyword">if</span> (stockUsedCount &gt; stockCount)&#123;</span><br><span class="line">        <span class="comment">//超出库存,恢复原始库存</span></span><br><span class="line">        stringRedisTemplate.opsForValue().decrement(stockKey,<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">StockResult</span>(Constants.ResponseCode.OUT_OF_STOCK.getCode(),Constants.ResponseCode.OUT_OF_STOCK.getInfo());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//扣减成功，以活动库存编号，生成对应的加锁key</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">stockTokenKey</span> <span class="operator">=</span> Constants.RedisKey.KEY_LOTTERY_ACTIVITY_STOCK_COUNT_TOKEN(activityId, stockUsedCount);</span><br><span class="line">    <span class="comment">//使用setnx加一个分布式锁并设置过期时间，以便其他线程也可以竞争锁</span></span><br><span class="line">    <span class="type">Boolean</span> <span class="variable">lockToken</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().setIfAbsent(stockTokenKey, <span class="string">&quot;1&quot;</span>, <span class="number">350L</span>, TimeUnit.MILLISECONDS);</span><br><span class="line">    <span class="keyword">if</span> (Boolean.FALSE.equals(lockToken))&#123;</span><br><span class="line">        <span class="comment">//加锁失败</span></span><br><span class="line">        stringRedisTemplate.opsForValue().decrement(stockKey,<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">StockResult</span>(Constants.ResponseCode.ERR_TOKEN.getCode(),Constants.ResponseCode.ERR_TOKEN.getInfo());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">StockResult</span>(Constants.ResponseCode.SUCCESS.getCode(),Constants.ResponseCode.SUCCESS.getInfo()</span><br><span class="line">                           ,stockTokenKey,stockCount - stockUsedCount);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>扣减活动库存成功，添加活动领取记录、扣减个人参与次数</p>
<ul>
<li><p>编程式事务，多个执行SQL，使用分库分表时会涉及多个数据源切换，注解式的事务不起作用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> Result <span class="title function_">grabActivity</span><span class="params">(PartakeReq req, ActivityBillVO bill, Long takeId)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        dbRouter.doRouter(req.getUId());</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 编程式事务，多个执行SQL，使用分库分表时会涉及多个数据源切换，注解式的事务不起作用</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">        <span class="keyword">return</span> transactionTemplate.execute(status-&gt;&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//扣减个人参与次数</span></span><br><span class="line">                <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> userTakeActivityRepository.subtractionLeftCount(bill.getActivityId(), bill.getActivityName(),</span><br><span class="line">                                                                            bill.getTakeCount(), bill.getUserTakeLeftCount(), req.getUId(), req.getPartakeTime());</span><br><span class="line">                <span class="keyword">if</span> (count == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">//扣减失败,回滚</span></span><br><span class="line">                    status.setRollbackOnly();</span><br><span class="line">                    logger.info(<span class="string">&quot;领取活动，扣减个人剩余参与次数失败 activityId:&#123;&#125; uId:&#123;&#125;&quot;</span>, req.getActivityId(), req.getUId());</span><br><span class="line">                    <span class="keyword">return</span> Result.buildResult(Constants.ResponseCode.NO_UPDATE);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//添加活动记录</span></span><br><span class="line">                <span class="comment">//                    int count1 =</span></span><br><span class="line">                userTakeActivityRepository.takeActivity(req.getUId(), bill.getStrategyId(),bill.getActivityId(), bill.getActivityName(),</span><br><span class="line">                                                        bill.getUserTakeLeftCount(), bill.getTakeCount(), req.getPartakeTime(), takeId);</span><br><span class="line">            &#125;<span class="keyword">catch</span> (DuplicateKeyException e)&#123;</span><br><span class="line">                status.setRollbackOnly();</span><br><span class="line">                logger.error(<span class="string">&quot;领取活动，唯一索引冲突 activityId：&#123;&#125; uId：&#123;&#125;&quot;</span>, req.getActivityId(), req.getUId(), e);</span><br><span class="line">                <span class="keyword">return</span> Result.buildResult(Constants.ResponseCode.INDEX_DUP);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> Result.buildSuccessResult();</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">        dbRouter.clear();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>释放锁，返回领取结果</p>
</li>
</ul>
</li>
</ul>
<h4 id="rule：规则引擎领域–组合模式"><a href="#rule：规则引擎领域–组合模式" class="headerlink" title="rule：规则引擎领域–组合模式"></a>rule：规则引擎领域–组合模式</h4><blockquote>
<p>量化人群得到活动ID</p>
</blockquote>
<ul>
<li><p>节点规则过滤：针对当前节点，遍历从这个节点出发的链路，根据决策物料与链路条件比较得到下一个节点</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Long <span class="title function_">filter</span><span class="params">(String matterValue, List&lt;TreeNodeLineVO&gt; treeNodeLineVOList)</span> &#123;</span><br><span class="line">    <span class="comment">//遍历节点每一个链路，找到符合条件的下一个节点</span></span><br><span class="line">    <span class="keyword">for</span> (TreeNodeLineVO treeNodeLineVO : treeNodeLineVOList) &#123;</span><br><span class="line">        <span class="keyword">if</span> (decisionLogic(matterValue,treeNodeLineVO))&#123;</span><br><span class="line">            <span class="keyword">return</span> treeNodeLineVO.getNodeIdTo();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//空节点</span></span><br><span class="line">    <span class="keyword">return</span> Constants.Global.TREE_NULL_NODE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">decisionLogic</span><span class="params">(String matterValue,TreeNodeLineVO treeNodeLineVO)</span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (treeNodeLineVO.getRuleLimitType())&#123;</span><br><span class="line">        <span class="keyword">case</span> Constants.RuleLimitType.EQUAL:</span><br><span class="line">            <span class="keyword">return</span> matterValue.equals(treeNodeLineVO.getRuleLimitValue());</span><br><span class="line">        <span class="keyword">case</span> Constants.RuleLimitType.GT:</span><br><span class="line">            <span class="keyword">return</span>  Double.parseDouble(matterValue) &gt; Double.parseDouble(treeNodeLineVO.getRuleLimitValue());</span><br><span class="line">        <span class="keyword">case</span> Constants.RuleLimitType.LT:</span><br><span class="line">            <span class="keyword">return</span>  Double.parseDouble(matterValue) &lt; Double.parseDouble(treeNodeLineVO.getRuleLimitValue());</span><br><span class="line">        <span class="keyword">case</span> Constants.RuleLimitType.GE:</span><br><span class="line">            <span class="keyword">return</span>  Double.parseDouble(matterValue) &gt;= Double.parseDouble(treeNodeLineVO.getRuleLimitValue());</span><br><span class="line">        <span class="keyword">case</span> Constants.RuleLimitType.LE:</span><br><span class="line">            <span class="keyword">return</span>  Double.parseDouble(matterValue) &lt;= Double.parseDouble(treeNodeLineVO.getRuleLimitValue());</span><br><span class="line">        <span class="keyword">default</span>: <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>规则引擎</p>
<ul>
<li><p>获取规则树聚合信息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> EngineResult <span class="title function_">process</span><span class="params">(DecisionMatterReq req)</span> &#123;</span><br><span class="line">    <span class="comment">//获取规则树聚合信息</span></span><br><span class="line">    <span class="type">TreeRuleRich</span> <span class="variable">treeRuleRich</span> <span class="operator">=</span> ruleRepository.queryTreeRuleRich(req.getTreeId());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (treeRuleRich==<span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Tree Rule is Null&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//根据决策物料和规则树聚合信息找到对应的果实活动</span></span><br><span class="line">    <span class="type">TreeNodeVO</span> <span class="variable">treeNodeVO</span> <span class="operator">=</span> engineDecisionMaker(treeRuleRich, req);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">EngineResult</span>(req.getUserId(),req.getTreeId(),treeNodeVO.getTreeNodeId(), treeNodeVO.getNodeValue());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>从根节点出发执行规则过滤直到果实节点</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据决策物料和规则树聚合信息找到对应的果实活动</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> treeRuleRich 规则树聚合信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> req  决策物料</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span>  果实活动节点</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="keyword">protected</span> TreeNodeVO <span class="title function_">engineDecisionMaker</span><span class="params">(TreeRuleRich treeRuleRich, DecisionMatterReq req)</span> &#123;</span><br><span class="line">    <span class="comment">//获取头节点</span></span><br><span class="line">    <span class="type">TreeRootVO</span> <span class="variable">treeRoot</span> <span class="operator">=</span> treeRuleRich.getTreeRoot();</span><br><span class="line">    <span class="comment">//获取节点与旗下链路对应关系的Map</span></span><br><span class="line">    Map&lt;Long, TreeNodeVO&gt; treeNodeMap = treeRuleRich.getTreeNodeMap();</span><br><span class="line">    <span class="comment">//树根ID</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">rootId</span> <span class="operator">=</span> treeRoot.getTreeRootNodeId();</span><br><span class="line">    <span class="comment">//得到树根节点的详细信息</span></span><br><span class="line">    <span class="type">TreeNodeVO</span> <span class="variable">treeNodeVO</span> <span class="operator">=</span> treeNodeMap.get(rootId);</span><br><span class="line">    <span class="comment">//当treeNodeVO为树茎时继续往下查找</span></span><br><span class="line">    <span class="keyword">while</span>(Constants.NodeType.STEM.equals(treeNodeVO.getNodeType()))&#123;</span><br><span class="line">        <span class="comment">//得到路由关键词</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">ruleKey</span> <span class="operator">=</span> treeNodeVO.getRuleKey();</span><br><span class="line">        <span class="comment">//获取对应的规则</span></span><br><span class="line">        <span class="type">LogicFilter</span> <span class="variable">logicFilter</span> <span class="operator">=</span> logicFilterMap.get(ruleKey);</span><br><span class="line">        <span class="comment">//根据获得的规则渠道对应的决策物料</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">matterValue</span> <span class="operator">=</span> logicFilter.matterValue(req);</span><br><span class="line">        <span class="comment">//执行找到下一个节点ID</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">nextNodeId</span> <span class="operator">=</span> logicFilter.filter(matterValue, treeNodeVO.getTreeNodeLineVOList());</span><br><span class="line">        treeNodeVO = treeNodeMap.get(nextNodeId);</span><br><span class="line">        logger.info(<span class="string">&quot;决策树引擎=&gt;&#123;&#125; userId：&#123;&#125; treeId：&#123;&#125; treeNode：&#123;&#125; ruleKey：&#123;&#125; matterValue：&#123;&#125;&quot;</span>,</span><br><span class="line">                    treeRoot.getTreeName(), req.getUserId(), req.getTreeId(),</span><br><span class="line">                    treeNodeVO.getTreeNodeId(), ruleKey, matterValue);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> treeNodeVO;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
</li>
</ul>
<h4 id="strategy：策略领域–策略、模板模式"><a href="#strategy：策略领域–策略、模板模式" class="headerlink" title="strategy：策略领域–策略、模板模式"></a>strategy：策略领域–策略、模板模式</h4><blockquote>
<p>根据策略算法执行抽奖得到奖品</p>
</blockquote>
<ul>
<li>根据策略ID获取抽奖策略</li>
<li>校验抽奖策略是否已经初始化到内存（总体概率无需先初始化到内存，因为抽奖概率随着奖品库存而改变，需要实时计算）<ul>
<li>单项概率：根据奖品概率将概率100%划分为几个部分，分别对其进行斐波那契散列定位到散列数组的某个位置，存放对应的奖品ID，这样执行抽奖时只需要对随机数进行斐波那契散列，取出对应位置的奖品ID即可</li>
</ul>
</li>
<li>获取不在抽奖范围内的奖品列表，包括库存为0、风控策略、临时调整等</li>
<li>策略模式调用对应策略算法执行抽奖<ul>
<li>单项概率：取出初始化到内存的对应策略的斐波那契散列数组，只需要对随机数进行斐波那契散列，取出对应位置的奖品ID即可，当奖品在排除的集合内，返回未中奖</li>
<li>总体概率：<ul>
<li>遍历策略下所有奖品信息，得到有效奖品集合与有效奖品总概率</li>
<li>遍历有效奖品集合，当前奖品概率除以有效奖品总概率就是真正的奖品概率，当随机数在当前奖品概率下，返回奖品ID</li>
</ul>
</li>
</ul>
</li>
<li>扣减奖品库存，包装中奖信息返回</li>
</ul>
<h4 id="award：发奖领域–简单工厂模式"><a href="#award：发奖领域–简单工厂模式" class="headerlink" title="award：发奖领域–简单工厂模式"></a>award：发奖领域–简单工厂模式</h4><blockquote>
<p>简单工厂模式：由工厂类来负责创建实例的过程，如果具体产品之间有功能的逻辑或，我们就必须把这些共同的东西提取出来，放在一个抽象类中，然后让具体产品继承抽象类，工厂根据传入参数返回不同 对象的实例。</p>
</blockquote>
<p>关于 award 发奖领域中主要的核心实现在于 service 中的两块功能逻辑实现，分别是： goods 商品处理 、 factory 工厂</p>
<ul>
<li><p>goods商品处理主要有：定义抽象类实现方法更改订单发货状态，不同发奖类型先执行自身逻辑，再调用更改发货状态</p>
<blockquote>
<p>接口类IDistributionGoods：抽象出doDistribution()接口作为发奖处理 </p>
<p>抽象类DistributionBase：提供商品处理的公共方法，供具体处理类继承 </p>
<p>N个实现类：继承DistributionBase抽象类，实现IDistributionGoods接口，为具体商品处理 类</p>
</blockquote>
</li>
<li><p>factory工厂：将不同发奖逻辑根据类型映射到Map中，后续通过工厂取出对应的发奖实现</p>
<blockquote>
<p>GoodsConfig配置类：定义awardType与商品处理类的对应关系，形成Map集合 </p>
<p>DistributionGoodsFactory工厂类：根据传入的awardType参数值返回不同的商品处理实例对象</p>
</blockquote>
</li>
</ul>
<p>在处理发奖业务时，只需要将奖品的类型awardType传入工厂类，即可获得与其对应的实现类实例对 象，执行相应的方法即可，避免逻辑混乱，使功能更加清晰易于扩展和维护，将创建者和具体的产品逻 辑解耦，满足单一职责</p>
<h3 id="lottery-infrastructure"><a href="#lottery-infrastructure" class="headerlink" title="lottery-infrastructure"></a>lottery-infrastructure</h3><blockquote>
<p>基础层，由领域层定义仓储接口，基础层实现，是依赖倒置的关系</p>
</blockquote>
<h3 id="lottery-common："><a href="#lottery-common：" class="headerlink" title="lottery-common："></a>lottery-common：</h3><blockquote>
<p>公共层，定义公共工具类、常量、异常处理、枚举等</p>
</blockquote>
<h2 id="DB-Router分库分表"><a href="#DB-Router分库分表" class="headerlink" title="DB-Router分库分表"></a>DB-Router分库分表</h2><h3 id="读取配置信息配置数据源"><a href="#读取配置信息配置数据源" class="headerlink" title="读取配置信息配置数据源"></a>读取配置信息配置数据源</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 数据源配置提取</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> environment 环境上下文</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setEnvironment</span><span class="params">(Environment environment)</span> &#123;</span><br><span class="line">    <span class="comment">//获取配置的前缀,方便定位yml中配置信息</span></span><br><span class="line">    String prefix=<span class="string">&quot;router.jdbc.datasource.&quot;</span>;</span><br><span class="line">    <span class="comment">//获取yml配置文件中设置的分库分表数量</span></span><br><span class="line">    dbCount=Integer.valueOf(environment.getProperty(prefix+<span class="string">&quot;dbCount&quot;</span>));</span><br><span class="line">    tbCount=Integer.valueOf(environment.getProperty(prefix+<span class="string">&quot;tbCount&quot;</span>));</span><br><span class="line">    routerKey= environment.getProperty(prefix+<span class="string">&quot;routerKey&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取数据源列表</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">datasources</span> <span class="operator">=</span> environment.getProperty(prefix + <span class="string">&quot;list&quot;</span>);</span><br><span class="line">    <span class="comment">//当数据源为null时中断</span></span><br><span class="line">    <span class="keyword">assert</span> datasources!=<span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">for</span> (String dataInfo: datasources.split(<span class="string">&quot;,&quot;</span>))&#123;</span><br><span class="line">        <span class="comment">//通过“,”分割数据源列表，获取配置信息，存入数据源配置组</span></span><br><span class="line">        Map&lt;String,Object&gt; dataSourceProps = PropertyUtil.handle(environment, prefix + dataInfo, Map.class);</span><br><span class="line">        dataSourceMap.put(dataInfo,dataSourceProps);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//默认数据源</span></span><br><span class="line">    String defaultData=environment.getProperty(prefix+<span class="string">&quot;default&quot;</span>);</span><br><span class="line">    defaultDataSourceConfig=PropertyUtil.handle(environment,prefix+defaultData,Map.class);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建数据源</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 动态数据源获取</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> DataSource <span class="title function_">dataSource</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="comment">//创建数据源</span></span><br><span class="line">    Map&lt;Object,Object&gt; targetDataSources=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">//遍历dataSourceMap获得每一个数据源配置信息</span></span><br><span class="line">    <span class="keyword">for</span> (String dataInfo : dataSourceMap.keySet()) &#123;</span><br><span class="line">        Map&lt;String, Object&gt; objMap = dataSourceMap.get(dataInfo);</span><br><span class="line">        <span class="comment">//根据数据源配置信息创建数据源</span></span><br><span class="line">        targetDataSources.put(dataInfo,</span><br><span class="line">                              <span class="keyword">new</span> <span class="title class_">DriverManagerDataSource</span>(objMap.get(<span class="string">&quot;url&quot;</span>).toString()</span><br><span class="line">                                                          ,objMap.get(<span class="string">&quot;username&quot;</span>).toString(),objMap.get(<span class="string">&quot;password&quot;</span>).toString()));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//设置数据源，DynamicDataSource用于动态获取数据源，所以先存入</span></span><br><span class="line">    DynamicDataSource dynamicDataSource=<span class="keyword">new</span> <span class="title class_">DynamicDataSource</span>();</span><br><span class="line">    <span class="comment">//设置动态数据源</span></span><br><span class="line">    dynamicDataSource.setTargetDataSources(targetDataSources);</span><br><span class="line">    <span class="comment">//设置默认数据源</span></span><br><span class="line">    dynamicDataSource.setDefaultTargetDataSource(<span class="keyword">new</span> <span class="title class_">DriverManagerDataSource</span>(</span><br><span class="line">        defaultDataSourceConfig.get(<span class="string">&quot;url&quot;</span>).toString(),</span><br><span class="line">        defaultDataSourceConfig.get(<span class="string">&quot;username&quot;</span>).toString(),</span><br><span class="line">        defaultDataSourceConfig.get(<span class="string">&quot;password&quot;</span>).toString()</span><br><span class="line">    ));</span><br><span class="line">    <span class="keyword">return</span> dynamicDataSource;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="事务管理器"><a href="#事务管理器" class="headerlink" title="事务管理器"></a>事务管理器</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 配置事务模板</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> TransactionTemplate <span class="title function_">transactionTemplate</span><span class="params">(DataSource dataSource)</span>&#123;</span><br><span class="line">    <span class="comment">//配置事务管理器，设置数据源</span></span><br><span class="line">    DataSourceTransactionManager dataSourceTransactionManager=<span class="keyword">new</span> <span class="title class_">DataSourceTransactionManager</span>();</span><br><span class="line">    dataSourceTransactionManager.setDataSource(dataSource);</span><br><span class="line"></span><br><span class="line">    TransactionTemplate transactionTemplate=<span class="keyword">new</span> <span class="title class_">TransactionTemplate</span>();</span><br><span class="line">    transactionTemplate.setTransactionManager(dataSourceTransactionManager);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//指定传播行为，&quot;PROPAGATION_REQUIRED&quot;表示若当前存在事务，则加入事务，若不存在则新建事务</span></span><br><span class="line">    transactionTemplate.setPropagationBehaviorName(<span class="string">&quot;PROPAGATION_REQUIRED&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> transactionTemplate;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="路由策略"><a href="#路由策略" class="headerlink" title="路由策略"></a>路由策略</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doRouter</span><span class="params">(String dbKeyAttr)</span> &#123;</span><br><span class="line">    <span class="comment">//hash桶的长度</span></span><br><span class="line">    <span class="type">int</span> size=dbRouterConfig.getDbCount()* dbRouterConfig.getTbCount();</span><br><span class="line">    <span class="comment">//设置扰动函数，使散列更加均匀，将hash值右移16位之后与本身做异或操作，再与（长度-1）相与使其落在hash桶上</span></span><br><span class="line">    <span class="type">int</span> idx=(size-<span class="number">1</span>)&amp;(dbKeyAttr.hashCode() ^ (dbKeyAttr.hashCode()&gt;&gt;&gt;<span class="number">16</span>));</span><br><span class="line">    <span class="comment">//每一个对idx都可以找到对应哪个库哪个表</span></span><br><span class="line">    <span class="comment">//对应库的索引等于idx除以分表的数量</span></span><br><span class="line">    <span class="type">int</span> dbIdx=idx / dbRouterConfig.getTbCount() +<span class="number">1</span>;</span><br><span class="line">    <span class="comment">//对应表的索引等于idx- 前一个库的所有表</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">tbIdx</span> <span class="operator">=</span> idx - dbRouterConfig.getTbCount() * (dbIdx - <span class="number">1</span>);</span><br><span class="line">    <span class="comment">//将当前库表索引存入ThreadLocal</span></span><br><span class="line">    DBContextHolder.setDbKey(String.format(<span class="string">&quot;%02d&quot;</span>,dbIdx));</span><br><span class="line">    DBContextHolder.setTbKey(String.format(<span class="string">&quot;%03d&quot;</span>,tbIdx));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="自定义DBRouter注解实现分库"><a href="#自定义DBRouter注解实现分库" class="headerlink" title="自定义DBRouter注解实现分库"></a>自定义DBRouter注解实现分库</h3><ul>
<li>切面逻辑：取出路由字段，为空则使用配置信息中指定的字段，得到路由字段的值执行路由策略</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Around(&quot;aopPoint()&amp;&amp;@annotation(dbRouter)&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">doRouter</span><span class="params">(ProceedingJoinPoint pj, DBRouter dbRouter)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">    <span class="comment">//路由字段</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">dbKey</span> <span class="operator">=</span> dbRouter.key();</span><br><span class="line">    <span class="comment">//如果路由字段为空</span></span><br><span class="line">    <span class="keyword">if</span>(StringUtils.isBlank(dbKey) &amp;&amp; StringUtils.isBlank(dbRouterConfig.getRouterKey()))&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;annotation DBRouter key is null&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    dbKey = StringUtils.isNotBlank(dbKey) ? dbKey : dbRouterConfig.getRouterKey();</span><br><span class="line">    <span class="comment">//获取路由属性,pj.getArgs()获取方法参数，进而获取参数对象的属性</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">dbKeyAttr</span> <span class="operator">=</span> getAttrValue(dbKey,pj.getArgs());</span><br><span class="line">    <span class="comment">//执行路由策略</span></span><br><span class="line">    dbRouterStrategy.doRouter(dbKeyAttr);</span><br><span class="line">    <span class="comment">//返回结果</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> pj.proceed();</span><br><span class="line">    &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">        dbRouterStrategy.clear();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>动态数据源切换</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DynamicDataSource</span> <span class="keyword">extends</span> <span class="title class_">AbstractRoutingDataSource</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Object <span class="title function_">determineCurrentLookupKey</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;db&quot;</span> + DBContextHolder.getDbKey();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="自定义DBRouterStrategy实现分表"><a href="#自定义DBRouterStrategy实现分表" class="headerlink" title="自定义DBRouterStrategy实现分表"></a>自定义DBRouterStrategy实现分表</h3><p><strong>采用<code>MyBatis Plugin StatementHandler</code>实现对SQL语句的拦截与修改</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> AZ</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> Mybatis拦截器，通过对SQL语句的拦截处理，修改分表信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2023/8/10 16:19</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Intercepts</span> 标识该类是一个拦截器；</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Signature</span> 指明自定义拦截器需要拦截哪一个类型，哪一个方法；</span></span><br><span class="line"><span class="comment"> * - type：上述四种类型中的一种；</span></span><br><span class="line"><span class="comment"> * - method：对应接口中的哪类方法（因为可能存在重载方法）；</span></span><br><span class="line"><span class="comment"> * - args：对应哪一个方法的入参；</span></span><br><span class="line"><span class="comment"> * 1.Executor：拦截执行器的方法。</span></span><br><span class="line"><span class="comment"> * 2.ParameterHandler：拦截参数的处理。</span></span><br><span class="line"><span class="comment"> * 3.ResultHandler：拦截结果集的处理。</span></span><br><span class="line"><span class="comment"> * 4.StatementHandler：拦截Sql语法构建的处理。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Intercepts(@Signature(type = StatementHandler.class,method = &quot;prepare&quot;,args = &#123;Connection.class,Integer.class&#125;))</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DynamicMybatisPlugin</span> <span class="keyword">implements</span> <span class="title class_">Interceptor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建了一个正则表达式的模式 `Pattern`，用于匹配 SQL 语句中的表名。该正则表达式可以匹配 `from`、`into` 或者 `update` 后面的表名。</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Pattern</span> <span class="variable">pattern</span> <span class="operator">=</span> Pattern.compile(<span class="string">&quot;(from|into|update)[\\s]&#123;1,&#125;(\\w&#123;1,&#125;)&quot;</span>, Pattern.CASE_INSENSITIVE);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">intercept</span><span class="params">(Invocation invocation)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="comment">//获取StatementHandler</span></span><br><span class="line">        <span class="type">StatementHandler</span> <span class="variable">statementHandler</span> <span class="operator">=</span> (StatementHandler) invocation.getTarget();</span><br><span class="line">        <span class="comment">//通过 `MetaObject` 获取`statementHandler` 对象的反射内容，方便后续对其属性进行操作</span></span><br><span class="line">        MetaObject metaObject=MetaObject.forObject(statementHandler, SystemMetaObject.DEFAULT_OBJECT_FACTORY,SystemMetaObject.DEFAULT_OBJECT_WRAPPER_FACTORY,<span class="keyword">new</span> <span class="title class_">DefaultReflectorFactory</span>());</span><br><span class="line">        <span class="comment">//获取MetaObject中&quot;delegate.mappedStatement&quot;属性值，即当前执行SQL语句的详细信息</span></span><br><span class="line">        <span class="type">MappedStatement</span> <span class="variable">mappedStatement</span> <span class="operator">=</span> (MappedStatement) metaObject.getValue(<span class="string">&quot;delegate.mappedStatement&quot;</span>);</span><br><span class="line">        <span class="comment">//获取类路径,如cn.az.middleware.db.router.DBContextHolder</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">id</span> <span class="operator">=</span> mappedStatement.getId();</span><br><span class="line">        <span class="comment">//根据类路径获取类名</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">className</span> <span class="operator">=</span> id.substring(<span class="number">0</span>, id.lastIndexOf(<span class="string">&quot;.&quot;</span>));</span><br><span class="line">        <span class="comment">//反射获得类信息</span></span><br><span class="line">        Class&lt;?&gt; clazz = Class.forName(className);</span><br><span class="line">        <span class="comment">//获取DBRouterStrategy注解信息</span></span><br><span class="line">        <span class="type">DBRouterStrategy</span> <span class="variable">dbRouterStrategy</span> <span class="operator">=</span> clazz.getAnnotation(DBRouterStrategy.class);</span><br><span class="line">        <span class="keyword">if</span>(dbRouterStrategy==<span class="literal">null</span>|| !dbRouterStrategy.spiltTable())&#123;</span><br><span class="line">            <span class="comment">//如果没有这个注解或者注解中是否分表的字段为否，直接放行</span></span><br><span class="line">            <span class="keyword">return</span> invocation.proceed();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//获取SQL</span></span><br><span class="line">        <span class="type">BoundSql</span> <span class="variable">boundSql</span> <span class="operator">=</span> statementHandler.getBoundSql();</span><br><span class="line">        <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> boundSql.getSql();</span><br><span class="line">        <span class="comment">//获取表名并替换，例：user -&gt; user03</span></span><br><span class="line">        <span class="type">Matcher</span> <span class="variable">matcher</span> <span class="operator">=</span> pattern.matcher(sql);</span><br><span class="line">        <span class="type">String</span> <span class="variable">tableName</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (matcher.find()) &#123;</span><br><span class="line">            tableName = matcher.group().trim();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">assert</span> tableName!=<span class="literal">null</span>;</span><br><span class="line">        <span class="comment">//替换表名</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">replaceSql</span> <span class="operator">=</span> matcher.replaceAll(tableName + <span class="string">&quot;_&quot;</span> + DBContextHolder.getTbKey());</span><br><span class="line">        <span class="comment">//通过反射修改sql语句</span></span><br><span class="line">        Field field=boundSql.getClass().getDeclaredField(<span class="string">&quot;sql&quot;</span>);</span><br><span class="line">        <span class="comment">//开启操作字段的权限</span></span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(boundSql,replaceSql);</span><br><span class="line">        field.setAccessible(<span class="literal">false</span>);</span><br><span class="line">        <span class="comment">//放行</span></span><br><span class="line">        <span class="keyword">return</span> invocation.proceed();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">AZ</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://ch-azkk.github.io/posts/520508/">https://ch-azkk.github.io/posts/520508/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://ch-azkk.github.io" target="_blank">AZのBLOG</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E9%A1%B9%E7%9B%AE%E7%BB%8F%E5%8E%86/">项目经历</a><a class="post-meta__tags" href="/tags/SpringBoot/">SpringBoot</a></div><div class="post_share"><div class="social-share" data-image="/img/project.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"/><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><nav class="pagination-post" id="pagination"><div class="next-post pull-full"><a href="/posts/520501/"><img class="next-cover" data-src="/img/class.png" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Acwing算法基础班</div></div></a></div></nav></article></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2023 - 2024  <i id="heartbeat" class="fa fas fa-heartbeat"></i> AZ</div><div class="framework-info"><span>驱动 </span><a target="_blank" rel="noopener" href="https://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly"><span>Butterfly</span></a></div></div><head><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/HCLonely/images@master/others/heartbeat.min.css"></head></footer></div><section id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="font_plus" type="button" title="放大字体"><i class="fas fa-plus"></i></button><button id="font_minus" type="button" title="缩小字体"><i class="fas fa-minus"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></section><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a target="_blank" rel="noopener" href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div class="search-mask"></div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/medium-zoom/dist/medium-zoom.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="/js/third-party/fireworks.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module" defer></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js" async></script><script src="/js/search/local-search.js"></script><script src="/js/calendar.js"></script><script src="/js/languages.js"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"scale":1.2,"jsonPath":"/live2dw/assets/hk416.model.json"},"display":{"width":200,"height":650,"position":"right","hOffset":0,"vOffset":-150},"mobile":{"show":true,"scale":0.5},"log":false});</script></body></html>